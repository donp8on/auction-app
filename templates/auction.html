<!DOCTYPE html>
<html>
<head>
  <title>Trojan Auctions</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family: Arial; padding: 2em; background-color: #f9f9f9; }
    h1 { color: rgb(220, 140, 20); }
    #log { border: 1px solid #ccc; padding: 1em; height: 300px; overflow-y: scroll; background: #fff; margin-top: 1em; }
    input, button { margin: 5px 0; padding: 8px; }
  </style>
  <style>
    #initAuction, #endAuctionBtn, #startAuctionBtn {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Trojan Auctions</h1>

  <!-- Join Section -->
  <div>
    <input type="text" id="username" placeholder="Enter your name" />
    <button onclick="joinAuction()">Join Auction</button>
  </div>

  <!-- Initialize Auction Form (first user only) -->
  <div id="initAuction" style="display:none; margin-top:20px;">
    <h3>Initialize Auction (First User Only)</h3>
    Item: <input type="text" id="item"><br>
    Min Price: <input type="number" id="min_price"><br>
    Type (1=First, 2=Second): <input type="number" id="type"><br>
    <button onclick="initAuction()">Initialize Auction</button>
  </div>

  <!-- Auction Bidding Interface -->
  <div id="auctionArea" style="display:none; margin-top:20px;">
    <p><strong>Item:</strong> <span id="itemName"></span></p>
    <p><strong>Minimum Price:</strong> $<span id="minPrice"></span></p>
    <p><strong>Auction Type:</strong> <span id="auctionType"></span></p>
    <p><strong>Users:</strong> <span id="users"></span></p>
    <p><strong>Time Remaining:</strong> <span id="timer">--</span></p>
    <input type="number" id="bidAmount" placeholder="Your Bid" />
    <button onclick="placeBid()">Place Bid</button>
    <button id="startAuctionBtn" onclick="startAuction()">Start Auction</button>
    <button id="endAuctionBtn" onclick="endAuction()">End Auction</button>
    <div id="log"></div>
  </div>

  <div id="newAuctionArea" style="display:none; margin-top: 20px;">
    <h3>üîÅ Start a New Auction</h3>
    Item: <input type="text" id="newItem"><br>
    Min Price: <input type="number" id="newMinPrice"><br>
    Type (1=First, 2=Second): <input type="number" id="newType"><br>
    <button onclick="startNewAuction()">Start New Auction</button>
  </div>

  <script>
    let socket = io();
    let username = "";
    let auctionInitialized = false;
    let isFirstUser = false;
    let isHost = false; // Track if the user is the host

    function joinAuction() {
      if (!username) {
        username = document.getElementById('username').value;
        if (!username) return alert("Enter your name first!");
        socket.emit('join', { username });

        // Assume first user is host (temporarily)
        isHost = true;
        document.getElementById('initAuction').style.display = 'block';
        document.getElementById('startAuctionBtn').style.display = 'inline-block';
        document.getElementById('endAuctionBtn').style.display = 'inline-block';
      } else {
        isHost = false;
        document.getElementById('bidAmount').style.display = 'inline-block';
        document.querySelector("button[onclick='placeBid()']").style.display = 'inline-block';
      }
      document.getElementById('auctionArea').style.display = 'block';
    }




    function initAuction() {
      const item = document.getElementById('item').value;
      const min_price = parseFloat(document.getElementById('min_price').value);
      const type = parseInt(document.getElementById('type').value);
      if (!item || isNaN(min_price) || isNaN(type)) return alert("Please fill all auction details.");
      socket.emit('initialize_auction', { item, min_price, type });
      document.getElementById('initAuction').style.display = 'none';
    }

    function startAuction() {
      socket.emit('start_auction');
    }

    function placeBid() {
      const bid = parseFloat(document.getElementById('bidAmount').value);
      if (!isNaN(bid)) {
        socket.emit('place_bid', { bid });
      }
    }

    socket.on('user_list', function(users) {
      document.getElementById('users').innerText = users.join(', ');
    });

    socket.on('auction_info', function(info) {
      auctionInitialized = true;
      document.getElementById('itemName').textContent = info.item;
      document.getElementById('minPrice').textContent = info.min_price;
      document.getElementById('auctionType').textContent = info.type == 1 ? 'First-Price' : 'Second-Price';
      document.getElementById('auctionArea').style.display = 'block';
      document.getElementById('initAuction').style.display = 'none';
      log(`Auction Initialized: ${info.item} (min $${info.min_price})`);
    });

    socket.on('new_bid', function(data) {
      log(`${data.user} placed a bid: $${data.bid}`);
    });

    socket.on('winner', function (data) {
      clearInterval(countdownInterval);
      document.getElementById("countdownText").textContent = "Auction Ended";
      log(`üèÜ ${data.message}`);

      // üéâ Trigger confetti
      confetti({
        particleCount: 150,
        spread: 100,
        origin: { y: 0.6 }
      });

      // Show start new auction for host
      if (isHost) {
        document.getElementById("newAuctionArea").style.display = "block";
        document.getElementById("startAuctionBtn").style.display = "none";
      }
    });


    socket.on('auction_started', function() {
      log('‚è≥ Auction started! You may now place your bids.');
      startCountdown(30);
    });

    function log(message) {
      const el = document.getElementById('log');
      el.innerHTML += `<div>${message}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    let countdownInterval;
    let remainingTime = 0;

    function startCountdown(duration) {
      clearInterval(countdownInterval);
      remainingTime = duration;
      document.getElementById("timer").textContent = `${remainingTime}s`;

      countdownInterval = setInterval(() => {
        remainingTime--;
        if (remainingTime >= 0) {
          document.getElementById("timer").textContent = `${remainingTime}s`;
        } else {
          clearInterval(countdownInterval);
          document.getElementById("timer").textContent = "Auction Ended";
        }
      }, 1000);
    }


    function endAuction() {
      socket.emit('end_auction');
      log("üö® Auction manually ended by user.");
    }

    

    function endAuction() {
      const confirmEnd = confirm("Are you sure you want to end the auction early?");
      if (confirmEnd) {
        socket.emit('end_auction');
        log("üö® Auction manually ended by the host.");
      }
    }

    function startNewAuction() {
      const item = document.getElementById("newItem").value;
      const min_price = parseFloat(document.getElementById("newMinPrice").value);
      const type = parseInt(document.getElementById("newType").value);

      if (!item || isNaN(min_price) || isNaN(type)) {
        alert("Please fill out all new auction details.");
        return;
      }

      socket.emit('initialize_auction', { item, min_price, type });
      document.getElementById("newAuctionArea").style.display = "none";
      log(`üéØ New auction initialized: ${item} ($${min_price})`);
    }


    socket.on('auction_ended', function() {
      log("üö® Auction has ended. You can start a new auction.");
      document.getElementById("newAuctionArea").style.display = "block";
      document.getElementById("auctionArea").style.display = "none";
    });


  </script>

  <div id="newAuctionArea" style="display:none; margin-top: 20px;">
    <h3>üîÅ Start a New Auction</h3>
    Item: <input type="text" id="newItem"><br>
    Min Price: <input type="number" id="newMinPrice"><br>
    Type (1=First, 2=Second): <input type="number" id="newType"><br>
    <button onclick="startNewAuction()">Start New Auction</button>
  </div>
</body>
</html>
<!-- End of auction.html -->